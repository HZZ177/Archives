# 缺陷管理功能重构实施方案

## 项目背景
将现有的手动录入Bug功能改造为从Coding平台API获取缺陷数据，保留模块关联和数据分析功能。

## Coding API信息
- **接口地址**: https://e.coding.net/open-api
- **请求方法**: POST
- **Action**: DescribeIssueList
- **认证方式**: Bearer Token

### 请求参数示例
```json
{
    "ProjectName": "项目名称",
    "IssueType": "DEFECT",
    "Offset": "0",
    "Limit": "50",
    "Conditions": [
        {"key": "ASSIGNEE", "value": ""},
        {"key": "ITERATION", "value": "64679"}
    ],
    "SortKey": "CODE",
    "SortValue": "DESC"
}
```

### 关键字段映射
- `Name` → 标题
- `Priority` → 严重程度 (1-最高, 2-高, 3-中, 4-低)
- `Description` → 内容描述
- `IssueStatusName` → 状态
- `CreatorId` → 创建人ID
- `CreatedAt` → 创建时间
- `Code` → Coding缺陷编号
- `Id` → Coding缺陷ID

## 实施步骤

### 阶段一：后端核心实现

#### 步骤1：创建Coding API集成服务
- [x] 创建 `backend/app/services/coding_service.py`
- [x] 实现从Coding API获取数据的方法
- [x] 实现数据格式转换逻辑
- [x] 状态：已完成

#### 步骤2：新增数据模型
- [x] 创建 `backend/app/models/coding_bug.py`
- [x] 创建 `backend/app/schemas/coding_bug.py`
- [x] 定义CodingBug相关的数据结构
- [x] 状态：已完成

#### 步骤3：新增配置管理
- [x] 创建Coding API配置相关模型和Schema
- [x] 实现工作区级别的API配置管理
- [x] 状态：已完成

#### 步骤4：重构API端点
- [x] **删除旧文件**: `backend/app/api/endpoints/bug.py`
- [x] 创建新的 `backend/app/api/endpoints/coding_bugs.py`
- [x] 实现从Coding获取缺陷数据的接口
- [x] 保留模块关联相关接口
- [x] 保留数据分析相关接口
- [x] 状态：已完成

### 阶段二：前端核心重构

#### 步骤5：重构缺陷管理主页面
- [x] 修改 `frontend/src/pages/bug-management/BugManagementPage.tsx`
- [x] 移除创建Bug的表单和按钮
- [x] 添加"从Coding同步"功能
- [x] 调整数据获取逻辑
- [x] 状态：已完成

#### 步骤6：重构模块Bug列表组件
- [x] 修改 `frontend/src/components/bug/ModuleBugList.tsx`
- [x] 移除"新建Bug"和"记录发生"功能
- [x] 保留Bug展示和关联功能
- [x] 状态：已完成

#### 步骤7：重构Bug关联面板
- [x] 修改 `frontend/src/components/bug/BugAssociationPanel.tsx`
- [x] 移除"记录新问题"按钮
- [x] 调整搜索逻辑为搜索Coding数据
- [x] 状态：已完成

#### 步骤8：调整Bug详情弹窗
- [x] 修改 `frontend/src/components/bug/BugDetailModal.tsx`
- [x] 移除"记录一次发生"按钮和发生历史
- [x] 调整显示字段为Coding数据字段
- [x] 状态：已完成

#### 步骤9：新增Coding配置界面
- [x] 创建 `frontend/src/components/coding/CodingConfigModal.tsx`
- [x] 实现API Token和项目名称配置界面
- [x] 集成到系统设置中
- [x] 状态：已完成

#### 步骤10：更新类型定义和API服务
- [x] 创建 `frontend/src/types/coding-bug.ts`
- [x] 创建 `frontend/src/apis/coding-bug.ts`
- [x] 调整为Coding API数据结构
- [x] 状态：已完成

#### 步骤11：调整模块内容编辑器
- [x] 修改 `frontend/src/pages/module-content/components/ModuleContentEditor.tsx`
- [x] 确保缺陷模块正确显示Coding数据
- [x] 状态：已完成

### 阶段三：配置和权限调整

#### 步骤12：更新权限定义
- [x] 修改权限初始化脚本
- [x] 移除创建Bug相关权限
- [x] 添加Coding配置管理权限
- [x] 状态：已完成

#### 步骤13：更新路由和配置
- [x] 调整路由配置
- [x] 更新前端常量定义
- [x] 状态：已完成

## 需要删除的旧文件
- `backend/app/api/endpoints/bug.py` (将被 `coding_bugs.py` 替代)
- 可能需要删除的其他Bug相关旧文件（根据实施过程确定）

## 保留的功能
- Bug与模块关联功能
- 数据分析Tab页面和统计功能
- Bug列表展示（数据源改为Coding API）
- Bug详情查看

## 移除的功能
- 手动创建Bug功能
- "记录一次发生"功能
- Bug发生日志相关功能

## 实施进度
- 总进度：13/13 步骤完成 ✅
- 当前阶段：已完成
- 开始时间：2025-01-03
- 完成时间：2025-01-03

## 重构完成总结

### 已完成的主要改动

**后端改动：**
1. ✅ 创建了完整的Coding API集成服务 (`coding_service.py`)
2. ✅ 新增了Coding缺陷数据模型 (`coding_bug.py`) 和Schema (`coding_bug.py`)
3. ✅ 实现了工作区级别的Coding配置管理服务
4. ✅ 重构了API端点，删除旧的 `bug.py`，创建新的 `coding_bugs.py`
5. ✅ 更新了权限定义，添加了细粒度的缺陷管理权限

**前端改动：**
1. ✅ 重构了缺陷管理主页面，移除手动创建功能，添加Coding同步功能
2. ✅ 重构了模块Bug列表组件，移除"新建Bug"和"记录发生"功能
3. ✅ 重构了Bug关联面板，调整为搜索Coding数据
4. ✅ 调整了Bug详情弹窗，移除发生历史，显示Coding数据字段
5. ✅ 新增了独立的Coding配置界面组件
6. ✅ 创建了新的类型定义和API服务文件

### 功能变更对比

| 功能 | 旧版本 | 新版本 |
|------|--------|--------|
| 数据来源 | 手动录入Bug档案 | 从Coding API实时获取 |
| 创建缺陷 | ✅ 支持手动创建 | ❌ 移除，改为同步 |
| 记录发生 | ✅ 支持记录发生次数 | ❌ 移除此功能 |
| 模块关联 | ✅ 支持关联到模块 | ✅ 保留并优化 |
| 数据分析 | ✅ 支持分析统计 | ✅ 保留功能 |
| 配置管理 | ❌ 无需配置 | ✅ 新增API配置 |

### 权限控制

采用页面级权限控制，简化权限管理：
- `workspace:resources:bugs` - 缺陷管理页面权限
  - 有此权限即可访问缺陷管理页面
  - 可以进行所有操作：查看、同步、关联、配置等

### 使用说明

1. **首次使用**：管理员需要在缺陷管理页面配置Coding API Token和项目名称
2. **同步数据**：点击"从Coding同步"按钮获取最新的缺陷数据
3. **关联模块**：在模块内容页面的缺陷模块中关联相关缺陷
4. **数据分析**：在缺陷管理页面的"数据分析"Tab查看统计信息

---
*重构已完成，所有功能已按计划实现*
