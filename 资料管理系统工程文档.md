# 企业内部资料管理系统工程文档

## 1. 项目概述

### 1.1 项目背景

本项目旨在开发一个企业内部资料管理系统，用于实现标准化的资料填充框架。系统面向企业内部人员开放，使其能够自主填充各个模块的内容。系统采用左右分栏布局，左侧为导航树，右侧为富文本编辑区域。

### 1.2 项目目标

- 建立标准化的资料填充框架
- 允许企业内部人员自主填充内容
- 支持资料的多模块管理
- 提供友好的用户界面和编辑体验
- 为后期RAG系统集成打下基础

### 1.3 技术栈概览

- 前端：React 18 + TypeScript + Ant Design 5.x
- 后端：FastAPI + SQLAlchemy
- 数据库：SQLite（初版）
- 认证：JWT
- 文件存储：本地文件系统

## 2. 系统架构设计

### 2.1 整体架构

系统采用前后端分离架构：
- 前端负责用户界面和交互逻辑
- 后端提供REST API接口
- 数据通过JSON格式交换
- 静态资源和上传文件存储在文件系统

```
Archives/
├── backend/              # 后端应用
│   ├── app/              # 应用代码
│   │   ├── api/          # API接口
│   │   │   ├── endpoints/  # API端点
│   │   │   └── deps.py     # 依赖项（认证等）
│   │   ├── core/         # 核心配置
│   │   ├── db/           # 数据库相关
│   │   ├── models/       # 数据模型
│   │   ├── schemas/      # Pydantic模型
│   │   └── main.py       # 应用入口
│   ├── static/           # 静态文件
│   ├── uploads/          # 上传文件存储
│   ├── alembic/          # 数据库迁移
│   └── requirements.txt  # 依赖管理
├── frontend/             # 前端应用
│   ├── public/           # 静态资源
│   ├── src/              # 源代码
│   │   ├── apis/         # API请求
│   │   ├── assets/       # 静态资源
│   │   ├── components/   # 组件
│   │   │   ├── common/   # 基础通用组件
│   │   │   └── business/ # 业务通用组件
│   │   ├── config/       # 配置文件
│   │   ├── contexts/     # React Context
│   │   ├── hooks/        # 自定义Hooks
│   │   ├── layouts/      # 布局
│   │   ├── pages/        # 页面
│   │   ├── router/       # 路由配置
│   │   ├── styles/       # 样式
│   │   ├── types/        # TypeScript类型
│   │   ├── utils/        # 工具函数
│   │   ├── App.tsx       # 应用入口组件
│   │   └── main.tsx      # 入口文件
│   └── package.json      # 依赖管理
└── .gitignore            # Git忽略配置
```

### 2.2 前端架构

- **核心框架**：React 18 + TypeScript
- **状态管理**：React Context API
- **路由管理**：React Router 6
- **UI组件库**：Ant Design 5.x
- **HTTP客户端**：Axios
- **富文本编辑**：Quill.js
- **构建工具**：Vite

### 2.3 后端架构

- **Web框架**：FastAPI
- **ORM**：SQLAlchemy (异步)
- **认证**：JWT（JSON Web Token）
- **文件处理**：Python内置库 + Pillow
- **API文档**：Swagger UI (FastAPI内置)
- **数据迁移**：Alembic

## 3. 数据模型详细设计

已经实现了完整的数据模型结构，包含以下实体：

### 3.1 用户相关模型 (models/user.py)

```python
class User(Base):
    """用户模型"""
    __tablename__ = "users"

    id = Column(Integer, primary_key=True, index=True)
    username = Column(String(50), unique=True, index=True, nullable=False)
    email = Column(String(100), unique=True, index=True, nullable=True)
    full_name = Column(String(100), nullable=True)
    hashed_password = Column(String(255), nullable=False)
    is_active = Column(Boolean, default=True)
    is_admin = Column(Boolean, default=False)
    created_at = Column(DateTime, default=datetime.datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.datetime.utcnow, onupdate=datetime.datetime.utcnow)

    # 关系
    roles = relationship("Role", secondary=user_role, back_populates="users")
    documents = relationship("Document", back_populates="creator")
    templates = relationship("Template", back_populates="creator")


class Role(Base):
    """角色模型"""
    __tablename__ = "roles"

    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(50), unique=True, index=True, nullable=False)
    description = Column(String(255), nullable=True)
    created_at = Column(DateTime, default=datetime.datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.datetime.utcnow, onupdate=datetime.datetime.utcnow)

    # 关系
    users = relationship("User", secondary=user_role, back_populates="roles")
```

### 3.2 文档相关模型 (models/document.py)

```python
class Document(Base):
    """文档模型"""
    __tablename__ = "documents"
    
    id = Column(Integer, primary_key=True, index=True)
    title = Column(String(100), nullable=False)
    description = Column(Text, nullable=True)
    template_id = Column(Integer, ForeignKey("templates.id"), nullable=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    created_at = Column(DateTime, default=datetime.datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.datetime.utcnow, onupdate=datetime.datetime.utcnow)
    
    # 关系
    creator = relationship("User", back_populates="documents")
    template = relationship("Template", back_populates="documents")
    sections = relationship("Section", back_populates="document", cascade="all, delete-orphan")
    images = relationship("Image", back_populates="document", cascade="all, delete-orphan")
    source_relations = relationship(
        "Relation", 
        foreign_keys="[Relation.source_id]", 
        back_populates="source", 
        cascade="all, delete-orphan"
    )
    target_relations = relationship(
        "Relation", 
        foreign_keys="[Relation.target_id]", 
        back_populates="target", 
        cascade="all, delete-orphan"
    )


class Template(Base):
    """模板模型"""
    __tablename__ = "templates"
    
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(100), nullable=False)
    description = Column(Text, nullable=True)
    structure = Column(Text, nullable=True)  # JSON字符串
    user_id = Column(Integer, ForeignKey("users.id"))
    created_at = Column(DateTime, default=datetime.datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.datetime.utcnow, onupdate=datetime.datetime.utcnow)
    
    # 关系
    creator = relationship("User", back_populates="templates")
    documents = relationship("Document", back_populates="template")


class Section(Base):
    """部分模型"""
    __tablename__ = "sections"
    
    id = Column(Integer, primary_key=True, index=True)
    document_id = Column(Integer, ForeignKey("documents.id", ondelete="CASCADE"), nullable=False)
    title = Column(String(100), nullable=False)
    content = Column(Text, nullable=True)
    type = Column(SQLAEnum(SectionTypeEnum), default=SectionTypeEnum.CONTENT)
    order = Column(Integer, default=0)
    created_at = Column(DateTime, default=datetime.datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.datetime.utcnow, onupdate=datetime.datetime.utcnow)
    
    # 关系
    document = relationship("Document", back_populates="sections")
    images = relationship("Image", back_populates="section", cascade="all, delete-orphan")


class Image(Base):
    """图片模型"""
    __tablename__ = "images"
    
    id = Column(Integer, primary_key=True, index=True)
    document_id = Column(Integer, ForeignKey("documents.id", ondelete="CASCADE"), nullable=False)
    section_id = Column(Integer, ForeignKey("sections.id", ondelete="SET NULL"), nullable=True)
    filename = Column(String(255), nullable=False)
    file_path = Column(String(255), nullable=False)
    url = Column(String(255), nullable=False)
    created_at = Column(DateTime, default=datetime.datetime.utcnow)
    
    # 关系
    document = relationship("Document", back_populates="images")
    section = relationship("Section", back_populates="images")


class Relation(Base):
    """关系模型"""
    __tablename__ = "relations"
    
    id = Column(Integer, primary_key=True, index=True)
    source_id = Column(Integer, ForeignKey("documents.id", ondelete="CASCADE"), nullable=False)
    target_id = Column(Integer, ForeignKey("documents.id", ondelete="CASCADE"), nullable=False)
    relation_type = Column(String(50), nullable=False)
    description = Column(Text, nullable=True)
    created_at = Column(DateTime, default=datetime.datetime.utcnow)
    
    # 关系
    source = relationship("Document", foreign_keys=[source_id], back_populates="source_relations")
    target = relationship("Document", foreign_keys=[target_id], back_populates="target_relations")
```

### 3.3 数据关系

- **用户与角色**：多对多关系，通过`user_role`关联表
- **用户与文档**：一对多关系，用户创建多个文档
- **用户与模板**：一对多关系，用户创建多个模板
- **模板与文档**：一对多关系，模板可用于创建多个文档
- **文档与部分**：一对多关系，文档包含多个内容部分
- **部分与图片**：一对多关系，部分可以包含多个图片
- **文档间关系**：通过关联表实现文档间的各种引用关系

## 4. API接口详细设计

已实现的API接口包括：

### 4.1 认证接口 (endpoints/auth.py)

- **POST /api/v1/auth/login**
  - 功能：用户登录获取令牌
  - 参数：用户名、密码
  - 返回：访问令牌

- **GET /api/v1/auth/profile**
  - 功能：获取当前登录用户信息
  - 参数：Bearer令牌
  - 返回：用户信息

### 4.2 用户管理接口 (endpoints/users.py)

- **GET /api/v1/users/**
  - 功能：获取用户列表
  - 权限：管理员

- **POST /api/v1/users/**
  - 功能：创建新用户
  - 权限：管理员
  - 参数：用户信息（用户名、密码等）

- **GET /api/v1/users/{user_id}**
  - 功能：获取指定用户信息
  - 权限：管理员或用户本人

- **PUT /api/v1/users/{user_id}**
  - 功能：更新用户信息
  - 权限：管理员或用户本人
  - 参数：更新的用户信息

- **DELETE /api/v1/users/{user_id}**
  - 功能：删除用户
  - 权限：管理员
  - 限制：不能删除当前登录用户

### 4.3 文档管理接口 (endpoints/documents.py)

- **GET /api/v1/documents/**
  - 功能：获取文档列表
  - 参数：分页参数

- **POST /api/v1/documents/**
  - 功能：创建新文档
  - 参数：文档信息（标题、描述、模板ID等）

- **GET /api/v1/documents/{document_id}**
  - 功能：获取文档详情
  - 权限：文档创建者或管理员

- **PUT /api/v1/documents/{document_id}**
  - 功能：更新文档
  - 权限：文档创建者或管理员
  - 参数：更新的文档信息

- **DELETE /api/v1/documents/{document_id}**
  - 功能：删除文档
  - 权限：文档创建者或管理员

- **POST /api/v1/documents/{document_id}/sections**
  - 功能：为文档添加部分
  - 权限：文档创建者或管理员
  - 参数：部分信息（标题、内容、顺序等）

- **GET /api/v1/documents/{document_id}/sections**
  - 功能：获取文档的所有部分
  - 权限：文档创建者或管理员

- **GET|PUT|DELETE /api/v1/documents/{document_id}/sections/{section_id}**
  - 功能：获取、更新或删除特定部分
  - 权限：文档创建者或管理员

### 4.4 模板管理接口 (endpoints/templates.py)

- **GET /api/v1/templates/**
  - 功能：获取模板列表
  - 参数：分页参数

- **POST /api/v1/templates/**
  - 功能：创建新模板
  - 权限：管理员
  - 参数：模板信息（名称、描述、结构等）

- **GET|PUT|DELETE /api/v1/templates/{template_id}**
  - 功能：获取、更新或删除模板
  - 权限：管理员

### 4.5 图片管理接口 (endpoints/images.py)

- **POST /api/v1/images/upload**
  - 功能：上传图片
  - 参数：图片文件、文档ID
  - 权限：文档创建者或管理员

- **GET /api/v1/images/document/{document_id}**
  - 功能：获取文档的所有图片
  - 权限：文档创建者或管理员

- **GET|DELETE /api/v1/images/{image_id}**
  - 功能：获取或删除特定图片
  - 权限：文档创建者或管理员

## 5. 前端设计

### 5.1 页面结构

```
├── 登录页 (/login)
├── 主应用
│   ├── 首页 (/)
│   ├── 文档管理 (/documents)
│   │   ├── 文档列表 (/documents)
│   │   └── 文档编辑 (/documents/[id])
│   │       ├── 概览
│   │       ├── 流程图
│   │       ├── 内容
│   │       ├── 数据表
│   │       └── API接口
│   ├── 模板管理 (/templates)
│   │   ├── 模板列表 (/templates)
│   │   └── 模板编辑 (/templates/[id])
│   └── 用户管理 (/users)
```

### 5.2 核心组件

#### 布局组件
- **MainLayout**: 主布局，包含侧边栏和主内容区
- **SideNav**: 侧边导航栏
- **Header**: 顶部导航栏，包含用户信息和操作按钮

#### 业务组件
- **DocumentEditor**: 文档编辑器，处理不同类型的内容编辑
- **RichTextEditor**: 富文本编辑器，基于Quill.js
- **ImageUploader**: 图片上传组件
- **ModuleSelector**: 模块选择器
- **APIInterface**: API接口展示组件

#### 辅助组件
- **AuthGuard**: 认证守卫组件，保护需要认证的路由
- **ErrorBoundary**: 错误边界，捕获渲染异常
- **LoadingSpinner**: 加载状态指示器

### 5.3 状态管理

使用React Context API管理全局状态：

- **AuthContext**: 管理用户认证状态和信息
- **DocumentContext**: 管理当前编辑的文档状态
- **NotificationContext**: 管理全局通知和消息

## 6. 安全设计

### 6.1 身份验证

- 使用JWT进行身份验证
- 令牌过期时间：7天
- 密码使用bcrypt哈希存储

### 6.2 权限控制

实现了基于角色的访问控制：
- **普通用户**: 只能操作自己创建的文档
- **管理员**: 可以管理所有用户和文档

### 6.3 API安全

- 所有请求使用HTTPS
- 敏感操作需要认证
- 实现了请求速率限制

## 7. 部署指南

### 7.1 环境要求

- **Python**: 3.8+
- **Node.js**: 16+
- **操作系统**: Linux/Windows/MacOS

### 7.2 后端部署

1. 安装依赖

```bash
cd backend
pip install -r requirements.txt
```

2. 配置环境变量
创建`.env`文件，设置必要的环境变量（数据库连接、密钥等）

3. 初始化数据库
```bash
alembic upgrade head
```

4. 启动服务
```bash
uvicorn app.main:app --host 0.0.0.0 --port 8000
```

### 7.3 前端部署

1. 安装依赖
```bash
cd frontend
npm install
```

2. 修改API配置
编辑`src/config/api.ts`，设置API基础URL

3. 构建生产版本
```bash
npm run build
```

4. 部署静态文件
可使用Nginx或其他Web服务器托管`dist`目录

## 8. 开发指南

### 8.1 后端开发

- 代码风格遵循PEP 8
- 所有功能需要编写单元测试
- API设计遵循RESTful原则
- 使用类型注解
- 保持文档的更新

### 8.2 前端开发

- 所有组件使用函数式组件
- 使用TypeScript进行类型检查
- 使用ESLint进行代码质量控制
- 文件命名规范：
  - 组件文件：PascalCase
  - 工具函数文件：camelCase
  - 类型定义文件：camelCase.d.ts
- 路由使用懒加载以提高性能

## 9. 已知问题和待优化项

1. **数据库扩展**：当前使用SQLite，未来可能需要迁移至PostgreSQL
2. **批量操作功能**：尚未实现文档的批量操作功能
3. **搜索功能**：需要添加全文搜索功能
4. **性能优化**：大量文档加载时可能存在性能问题
5. **RAG系统集成**：预留了接口，但尚未实现

## 10. 未来规划

### 10.1 短期规划
- 完善搜索功能
- 添加批量操作
- UI/UX优化
- 性能优化

### 10.2 中期规划
- 数据库迁移至PostgreSQL
- 添加历史版本功能
- 集成流程图在线编辑

### 10.3 长期规划
- RAG系统集成
- 智能推荐功能
- 与其他企业系统集成 